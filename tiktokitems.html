<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<title>TikTok Items</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, doc, getDoc, getDocs, onSnapshot, setDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDTIzoJlvrr0mYxwx82cQ9JJn8rXrMEy7JA",
    authDomain: "reps-central.firebaseapp.com",
    projectId: "reps-central",
    storageBucket: "reps-central.firebasestorage.app",
    messagingSenderId: "812299387060",
    appId: "1:812299387060:web:1c93d1e7bf30b565536d7e1",
    measurementId: "G-8T7F9F1FZ9"
  };

  const ADMIN_UID = "Z9rgul3dEUONsJCcjoK51aNgHQo2";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentVideoID = null;

  onAuthStateChanged(auth, user => {
    if (user && user.uid === ADMIN_UID) {
      document.body.classList.add("admin-mode");
      document.getElementById("adminLoginBtn").classList.add("hidden");
      document.getElementById("adminLogoutBtn").classList.remove("hidden");
    } else {
      document.body.classList.remove("admin-mode");
      document.getElementById("adminLoginBtn").classList.remove("hidden");
      document.getElementById("adminLogoutBtn").classList.add("hidden");
    }
  });

  async function loadGrid() {
    const ref = collection(db, "tiktok_videos");
    onSnapshot(ref, snap => {
      const grid = document.getElementById("videoGrid");
      grid.innerHTML = "";
      let videos = [];
      snap.forEach(docu => videos.push({ id: docu.id, ...docu.data() }));
      videos.sort((a,b) => b.createdAt - a.createdAt);
      videos.forEach(v => {
        grid.innerHTML += `
          <div onclick="openViewer('${v.id}')" class='cursor-pointer hover:scale-95 transition'>
            <img src="${v.thumbnail}" class="rounded-xl shadow-lg border" />
          </div>`;
      });
    });
  }

  window.openViewer = async function(id) {
    currentVideoID = id;
    document.getElementById("viewer").classList.remove("hidden");
    document.getElementById("videoFrame").innerHTML = `
      <blockquote class="tiktok-embed" data-video-id="${id}"></blockquote>
      <script async src="https://www.tiktok.com/embed.js"></script>
    `;
    loadAssignedItems(id);
  }

  async function loadAssignedItems(vid) {
    const box = document.getElementById("itemsBox");
    box.innerHTML = "<p class='animate-pulse text-gray-500'>Processing items...</p>";
    const ref = doc(db, "tiktok_video_items", vid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      box.innerHTML = `
        <div class='text-center'>
          <div class='animate-bounce text-5xl'>‚òÅ</div>
          <p class='text-gray-500'>Items being processed...</p>
        </div>`;
      return;
    }

    let html = "";
    for (let id of snap.data().items) {
      const itemRef = doc(db, "tiktokitems", id);
      const itemSnap = await getDoc(itemRef);
      if (itemSnap.exists()) {
        let d = itemSnap.data();
        html += `
          <div class='p-3 border rounded-xl mb-3'>
            <img src="${d.image}" class="w-20 rounded mb-2"/>
            <p class='font-bold'>${d.title}</p>
            <p class='text-sm'>${d.price} USD</p>
            <a class='text-blue-500 underline' href="${d.url}" target="_blank">Buy</a>
          </div>`;
      }
    }
    box.innerHTML = html;
  }

  window.openAdminLogin = function() {
    document.getElementById("loginModal").classList.remove("hidden");
  };

  window.doLogin = async function() {
    const email = document.getElementById("adminEmail").value;
    const pass = document.getElementById("adminPass").value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      document.getElementById("loginModal").classList.add("hidden");
    } catch {
      alert("Login failed");
    }
  };

  window.doLogout = function() { signOut(auth); };

  window.openAssign = async function() {
    if (!currentVideoID) return;
    document.getElementById("assignModal").classList.remove("hidden");

    const ref = collection(db, "tiktokitems");
    const snap = await getDocs(ref);

    const box = document.getElementById("assignList");
    box.innerHTML = "";

    snap.forEach(docu => {
      let d = docu.data();
      box.innerHTML += `
        <label class='flex items-center gap-2 mb-2'>
          <input type='checkbox' value='${docu.id}' class='assignCheck'>
          <span>${d.title}</span>
        </label>`;
    });
  };

  window.saveAssign = async function() {
    let selected = [];
    document.querySelectorAll(".assignCheck:checked").forEach(c => selected.push(c.value));
    await setDoc(doc(db, "tiktok_video_items", currentVideoID), {
      items: selected,
      assignedBy: ADMIN_UID,
      assignedAt: Date.now()
    });
    document.getElementById("assignModal").classList.add("hidden");
    loadAssignedItems(currentVideoID);
  };

  loadGrid();
</script>

<style>
  body.admin-mode #assignBtn { display: block; }
  #assignBtn { display: none; }
</style>

</head>

<body class="p-6 bg-gray-50">

<div class="flex justify-between mb-6">
  <h1 class="text-3xl font-bold">TikTok Items</h1>
  <button id="adminLoginBtn" onclick="openAdminLogin()" class="px-3 py-1 rounded bg-gray-800 text-white">Admin Login</button>
  <button id="adminLogoutBtn" onclick="doLogout()" class="px-3 py-1 rounded bg-red-600 text-white hidden">Logout</button>
</div>

<div id="videoGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

<div id="viewer" class="hidden fixed inset-0 bg-black/60 flex p-6 gap-6 overflow-auto">
  <div id="videoFrame" class="bg-white p-4 rounded-xl w-1/2"></div>
  <div id="itemsBox" class="bg-white p-4 rounded-xl w-1/2 overflow-y-auto"></div>
  <button id="assignBtn" onclick="openAssign()" class="absolute bottom-6 right-6 bg-blue-600 text-white px-4 py-2 rounded-xl shadow">Assign Items</button>
</div>

<div id="loginModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl w-80">
    <h2 class="font-bold text-lg mb-3">Admin Login</h2>
    <input id="adminEmail" class="w-full border p-2 mb-2" placeholder="Email">
    <input id="adminPass" type="password" class="w-full border p-2 mb-4" placeholder="Password">
    <button onclick="doLogin()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
  </div>
</div>

<div id="assignModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl w-96 max-h-[80vh] overflow-y-auto">
    <h2 class="font-bold text-lg mb-3">Assign Items</h2>
    <div id="assignList"></div>
    <button onclick="saveAssign()" class="bg-green-600 text-white px-4 py-2 rounded w-full mt-4">Save</button>
  </div>
</div>

</body>
</html>
