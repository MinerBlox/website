<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<title>TikTok Items</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, onSnapshot, setDoc } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = { /* same config */ };

const ADMIN_UID = "Z9rgul3dEUONsJCcjoK51aNgHQo2";
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentVideoID = null;

onAuthStateChanged(auth, user => {
  if (user && user.uid === ADMIN_UID) {
    document.body.classList.add("admin-mode");
  } else {
    document.body.classList.remove("admin-mode");
  }
});

async function loadGrid() {
  const ref = collection(db, "tiktok_videos");
  onSnapshot(ref, snap => {
    const grid = document.getElementById("videoGrid");
    grid.innerHTML = "";
    let videos = [];
    snap.forEach(docu => videos.push({ id: docu.id, ...docu.data() }));
    videos.sort((a,b) => b.createdAt - a.createdAt);
    videos.forEach(v => {
      grid.innerHTML += `<div onclick="openViewer('${v.id}')" class='cursor-pointer'>
        <img src="${v.thumbnail}" class="rounded-xl shadow-lg border" />
      </div>`;
    });
  });
}

window.openViewer = async function(id) {
  currentVideoID = id;
  document.getElementById("viewer").classList.remove("hidden");
  document.getElementById("videoFrame").innerHTML = `
    <blockquote class="tiktok-embed" data-video-id="${id}"></blockquote>
    <script async src="https://www.tiktok.com/embed.js"><\/script>`;
  loadAssignedItems(id);
}

async function loadAssignedItems(videoId) {
  const box = document.getElementById("itemsBox");
  box.innerHTML = `<p class="text-gray-500 animate-pulse">Checking for itemsâ€¦</p>`;
  const ref = doc(db, "tiktok_video_items", videoId);
  const snap = await getDoc(ref);

  if (!snap.exists() || !(snap.data().items) || snap.data().items.length === 0) {
    box.innerHTML = `
      <div class="text-center py-6">
        <div class='animate-bounce text-6xl mb-3'>ðŸ›’</div>
        <p class='text-xl font-semibold text-gray-700'>Detecting Products</p>
        <p class='text-gray-500'>Come back later...</p>
      </div>`;
    return;
  }

  let html = "";
  for (const itemId of snap.data().items) {
    const itemRef = doc(db, "tiktokitems", itemId);
    const itemSnap = await getDoc(itemRef);
    if (itemSnap.exists()) {
      const d = itemSnap.data();
      html += `<div class="p-3 border rounded-xl mb-4 shadow-sm bg-white">
        <img src="${d.image}" class="w-24 rounded mb-2"/>
        <p class="font-bold">${d.title}</p>
        <p class="text-sm text-gray-700">${d.price} USD</p>
        <a class="text-blue-500 underline" href="${d.url}" target="_blank">Buy</a>
      </div>`;
    }
  }
  box.innerHTML = html;
}

loadGrid();
</script>
</head>
<body>
<div id="videoGrid" class="grid grid-cols-3 gap-4 p-4"></div>
<div id="viewer" class="hidden p-4">
  <div id="videoFrame"></div>
  <div id="itemsBox" class="mt-4"></div>
</div>
</body>
</html>
