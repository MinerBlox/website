<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Video Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "primary-dark": "#111827",
        "primary-light": "#FFFFFF",
        accent: "#00AEEF",
        subtle: "#E5E7EB",
        "background-light": "#F8F8F8",
      }
    }
  }
}
</script>

<style>
body { background:#f8f8f8; }

.header-gradient {
  background: linear-gradient(135deg, #ffffff 60%, #e0f7fa 100%);
}

/* Item square thumbnail */
.item-thumb {
  width: 80px;
  height: 80px;
  border-radius: 10px;
  overflow: hidden;
  flex-shrink: 0;
}
.item-thumb img {
  width: 100%; height: 100%; object-fit: cover;
}

/* Video shadow */
.video-shadow {
  box-shadow: 0px 10px 25px rgba(0,0,0,0.25);
  border-radius: 12px;
}
</style>
</head>

<body class="font-sans text-gray-800">

<!-- SIDEBAR -->
<div id="sidebar"
     class="fixed top-0 left-0 h-full w-64 p-6 shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 bg-white border-r border-subtle">

  <h3 class="text-xl font-bold text-accent mb-6">Navigation</h3>

  <nav class="flex flex-col space-y-3">
    <button onclick="navigate('home')" class="text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-100">Home</button>
    <button onclick="navigate('data')" class="text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-100">Spreadsheet</button>
    <button onclick="navigate('link-converter')" class="text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-100">Link Converter</button>
    <button onclick="navigate('trusted-sellers')" class="text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-100">Trusted Sellers</button>
    <button onclick="navigate('tiktok-items')" class="text-left py-2 px-3 rounded-lg font-medium bg-gray-200">TikTok Videos</button>
  </nav>
</div>

<div id="sidebarBackdrop"
     onclick="toggleSidebar()"
     class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>


<!-- MAIN WRAPPER -->
<div class="max-w-7xl mx-auto p-4 sm:p-8">

  <!-- HEADER -->
  <header class="header-gradient flex justify-between items-center mb-6 pb-4 rounded-b-xl shadow-md px-4 sm:px-8 pt-4">
    <svg onclick="toggleSidebar()" class="w-8 h-8 text-accent cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>

    <img onclick="navigate('home')"
         src="https://raw.githubusercontent.com/MinerBlox/website/refs/heads/main/images/mainlogo.png"
         class="h-10 cursor-pointer">

    <button onclick="openAdmin()" class="text-gray-700">Admin?</button>
  </header>

  <!-- ADMIN MODAL -->
  <div id="adminModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl w-72">
      <h2 class="text-lg font-bold mb-3">Admin Unlock</h2>
      <input id="adminPass" type="password" placeholder="Password: admintest" class="w-full p-2 border rounded mb-4">
      <button onclick="doAdminLogin()" class="bg-blue-500 text-white w-full py-2 rounded">Unlock</button>
    </div>
  </div>

  <!-- VIDEO + RIGHT PANEL -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- LEFT: VIDEO ONLY -->
    <div>
      <video id="videoPlayer"
             class="w-full video-shadow"
             controls
             playsinline></video>
    </div>

    <!-- RIGHT: INFO + ITEMS -->
    <div class="bg-white p-6 rounded-xl shadow">

      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 id="videoTitle" class="text-2xl font-bold"></h1>
          <p id="videoDesc" class="text-gray-600 mt-2"></p>
        </div>

        <button id="editItemsBtn"
                onclick="openItemPicker()"
                class="hidden bg-blue-500 text-white px-3 py-1 rounded">
          Edit
        </button>
      </div>

      <div class="border-t border-gray-200 my-4"></div>

      <h2 class="text-lg font-semibold mb-2">Items</h2>
      <div id="assignedItems" class="space-y-3"></div>

    </div>

  </div>


  <!-- ITEM PICKER MODAL -->
  <div id="itemPickerModal"
       class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

    <div class="relative bg-white w-full max-w-3xl max-h-[85vh] overflow-y-auto p-6 rounded-xl shadow-xl">

      <!-- CLOSE BUTTON -->
      <button onclick="closeItemPicker()"
              class="absolute top-4 right-4 text-gray-500 hover:text-black text-2xl leading-none">
        &times;
      </button>

      <h2 class="text-2xl font-bold mb-4">Select Items</h2>

      <div id="itemPickerGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>

      <div class="flex justify-end mt-6">
        <button onclick="saveItemSelection()"
                class="bg-blue-500 text-white px-5 py-2 rounded">
          Save
        </button>
      </div>
    </div>
  </div>

</div><!-- END MAIN WRAPPER -->


<!-- FIREBASE LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyDTI2oJIvrtQmYxwz8t2CQ9JJn8r7kMEy7JA",
    authDomain:"reps-central.firebaseapp.com",
    projectId:"reps-central",
    storageBucket:"reps-central.firebasestorage.app",
    messagingSenderId:"812299387060",
    appId:"1:812299387060:web:1c93d1e7bf30b65653d7e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* GLOBAL STATE */
let isAdmin = false;
let videoID = new URLSearchParams(location.search).get("id");
let currentItems = [];
let allItems = {};



/* ADMIN */
window.openAdmin = () => adminModal.classList.remove("hidden");
function closeAdmin(){ adminModal.classList.add("hidden"); }

window.doAdminLogin = () => {
  if(adminPass.value === "admintest"){
    isAdmin = true;
    document.getElementById("editItemsBtn").classList.remove("hidden");
    closeAdmin();
  } else {
    alert("Incorrect admin password.");
  }
};


/* SIDEBAR NAVIGATION */
window.toggleSidebar = () => {
  const sb = document.getElementById('sidebar');
  const bg = document.getElementById('sidebarBackdrop');
  const closed = sb.classList.contains("-translate-x-full");

  if(closed){
    sb.classList.remove("-translate-x-full");
    bg.classList.remove("hidden");
  } else {
    sb.classList.add("-translate-x-full");
    bg.classList.add("hidden");
  }
};

window.navigate = (p) => {
  if(p === "home") location.href = "index.html";
  if(p === "data") location.href = "products.html";
  if(p === "link-converter") location.href = "link-converter.html";
  if(p === "trusted-sellers") location.href = "trusted-sellers.html";
  if(p === "tiktok-items") location.href = "tiktokitems (2).html";
};


/* LOAD VIDEO */
async function loadVideo(){
  const snap = await getDoc(doc(db, "tiktokvideos", videoID));
  if(!snap.exists()){
    alert("Video not found");
    return;
  }

  const d = snap.data();

  videoPlayer.src = d.videourl || "";
  videoTitle.textContent = d.name || "Untitled Video";
  videoDesc.textContent = d.description || "";
  currentItems = d.items || [];

  loadAssignedItems();
}

async function loadAssignedItems(){
  const container = document.getElementById("assignedItems");
  container.innerHTML = "";

  for(const id of currentItems){
    const snap = await getDoc(doc(db, "tiktokitems", id));
    if(!snap.exists()) continue;

    const item = snap.data();

    const pillClass =
      item.availability === "Available" ? "bg-green-500 text-white" :
      item.availability === "Low Stock" ? "bg-amber-500 text-white" :
      item.availability === "Dead" ? "bg-red-500 text-white" :
      "bg-gray-500 text-white";

    container.innerHTML += `
      <div class="flex items-center gap-4 p-3 rounded-xl bg-gray-100 shadow">
        <div class="item-thumb">
          <img src="${item.image}">
        </div>

        <div class="flex flex-col justify-center">
          <div class="font-semibold">${item.title}</div>
          <div class="text-sm text-gray-600">¥${item.price}</div>
        </div>

        <div class="ml-auto">
          <span class="px-3 py-1 text-xs rounded-full ${pillClass}">
            ${item.availability}
          </span>
        </div>
      </div>
    `;
  }
}


/* ITEM PICKER */
window.openItemPicker = async () => {
  itemPickerModal.classList.remove("hidden");

  const grid = document.getElementById("itemPickerGrid");
  grid.innerHTML = "";

  allItems = {};
  const snap = await getDocs(collection(db, "tiktokitems"));

  snap.forEach(docSnap => {
    allItems[docSnap.id] = docSnap.data();
  });

  for(const id in allItems){
    const item = allItems[id];
    const selected = currentItems.includes(id) ? "ring-4 ring-blue-500" : "";

    grid.innerHTML += `
      <div onclick="toggleItem('${id}')"
           id="pick_${id}"
           class="border rounded-xl p-3 cursor-pointer hover:shadow ${selected}">
        
        <div class="item-thumb mb-2" style="width:100%; padding-top:100%; position:relative;">
          <img src="${item.image}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;">
        </div>

        <div class="font-semibold">${item.title}</div>
        <div class="text-sm text-gray-600">¥${item.price}</div>
        <div class="text-xs text-gray-500">${item.category}</div>
        <div class="text-xs mt-1 font-semibold ${
            item.availability === 'Available' ? 'text-green-600' :
            item.availability === 'Low Stock' ? 'text-amber-600' :
            item.availability === 'Dead' ? 'text-red-600' :
            'text-gray-600'
        }">${item.availability}</div>
      </div>
    `;
  }
};

window.closeItemPicker = () => {
  itemPickerModal.classList.add("hidden");
};

window.toggleItem = (id) => {
  const el = document.getElementById("pick_" + id);

  if(currentItems.includes(id)){
    currentItems = currentItems.filter(x => x !== id);
    el.classList.remove("ring-4", "ring-blue-500");
  } else {
    currentItems.push(id);
    el.classList.add("ring-4", "ring-blue-500");
  }
};

window.saveItemSelection = async () => {
  try {
    await updateDoc(doc(db, "tiktokvideos", videoID), {
      items: currentItems
    });

    closeItemPicker();
    loadAssignedItems();
  } catch (err) {
    console.error(err);
    alert("Failed to save changes: " + err.message);
  }
};


/* INIT */
loadVideo();

</script>
</body>
</html>
