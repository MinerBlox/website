<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reps Central Console</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "primary-dark": "#111827",
            "primary-light": "#FFFFFF",
            accent: "#00AEEF",
            subtle: "#E5E7EB",
            "background-light": "#F8F8F8",
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    body {
      background-color: var(--background-light, #f8f8f8);
      color: #4b5563;
    }

    .text-primary-dark {
      color: #111827 !important;
    }

    .card,
    .tiled-product-card {
      background-color: white !important;
      border-color: #e5e7eb !important;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -2px rgba(0, 0, 0, 0.06) !important;
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1),
        0 5px 10px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-4px);
    }
    .border-subtle {
      border-color: #e5e7eb;
    }

    .header-gradient {
      background: linear-gradient(135deg, #ffffff 60%, #e0f7fa 100%);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.65rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 9999px;
      background-size: 200% 100%;
      transition: background 0.5s ease;
      animation: subtle-shift-pill 4s linear infinite alternate;
    }

    @keyframes subtle-shift-pill {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 100% 50%;
      }
    }

    .status-available {
      background-image: linear-gradient(90deg, #10b981, #00aeef);
      color: white;
      box-shadow: 0 1px 3px rgba(16, 185, 129, 0.4);
    }
    .status-dead {
      background-image: linear-gradient(90deg, #ef4444, #ec4899);
      color: white;
      box-shadow: 0 1px 3px rgba(239, 68, 68, 0.4);
    }
    .status-low-stock {
      background-image: linear-gradient(90deg, #f59e0b, #f97316);
      color: white;
      box-shadow: 0 1px 3px rgba(245, 158, 11, 0.4);
    }
    .status-checking {
      background-image: linear-gradient(90deg, #64748b, #475569);
      color: white;
      box-shadow: 0 1px 3px rgba(100, 116, 139, 0.4);
    }

    .home-nav-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 700;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .home-nav-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .auto-scroll-viewport {
      height: 500px;
      overflow: hidden;
      position: relative;
      mask-image: linear-gradient(
        to bottom,
        transparent 0%,
        black 5%,
        black 95%,
        transparent 100%
      );
      -webkit-mask-image: linear-gradient(
        to bottom,
        transparent 0%,
        black 5%,
        black 95%,
        transparent 100%
      );
      padding: 1rem 0;
    }

    .scrolling-content-wrapper {
      animation: autoScroll var(--scroll-duration, 15s) linear infinite;
      will-change: transform;
    }

    @keyframes autoScroll {
      0% {
        transform: translateY(0);
      }
      100% {
        transform: translateY(var(--scroll-distance, -1000px));
      }
    }

    @keyframes shake {
      10%,
      90% {
        transform: translate3d(-1px, 0, 0);
      }
      20%,
      80% {
        transform: translate3d(2px, 0, 0);
      }
      30%,
      50%,
      70% {
        transform: translate3d(-4px, 0, 0);
      }
      40%,
      60% {
        transform: translate3d(4px, 0, 0);
      }
    }
    .animate-shake {
      animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    }

    .glow-box {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 0.75rem;
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 1.125rem;
      cursor: pointer;
      padding: 1.5rem;
    }
    .glow-box:hover {
      transform: translateY(-5px) scale(1.03);
    }
    .glow-box-blue {
      background-color: #3b82f6;
      box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.4);
    }
    .glow-box-blue:hover {
      box-shadow: 0 0 30px 10px rgba(59, 130, 246, 0.5);
    }
    .glow-box-red {
      background-color: #ef4444;
      box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.4);
    }
    .glow-box-red:hover {
      box-shadow: 0 0 30px 10px rgba(239, 68, 68, 0.5);
    }
    .glow-box-emerald {
      background-color: #10b981;
      box-shadow: 0 0 20px 5px rgba(16, 185, 129, 0.4);
    }
    .glow-box-emerald:hover {
      box-shadow: 0 0 30px 10px rgba(16, 185, 129, 0.5);
    }
    .glow-box-purple {
      background-color: #8b5cf6;
      box-shadow: 0 0 20px 5px rgba(139, 92, 246, 0.4);
    }
    .glow-box-purple:hover {
      box-shadow: 0 0 30px 10px rgba(139, 92, 246, 0.5);
    }
    .glow-box-amber {
      background-color: #f59e0b;
      box-shadow: 0 0 20px 5px rgba(245, 158, 11, 0.4);
    }
    .glow-box-amber:hover {
      box-shadow: 0 0 30px 10px rgba(245, 158, 11, 0.5);
    }
    .glow-box-slate {
      background-color: #64748b;
      box-shadow: 0 0 20px 5px rgba(100, 116, 139, 0.4);
    }
    .glow-box-slate:hover {
      box-shadow: 0 0 30px 10px rgba(100, 116, 139, 0.5);
    }
    .glow-box-orange-rec {
      background-color: #f97316;
      border: 2px solid #fb923c;
      box-shadow: 0 0 20px 8px rgba(251, 146, 60, 0.5);
    }
  
/* Trusted seller cards */
.trusted-seller-glow {
  position: relative;
  border-radius: 1rem;
  box-shadow: 0 0 0 0 rgba(0,0,0,0);
  transition: box-shadow 0.4s ease, transform 0.3s ease;
}
.trusted-seller-glow:hover {
  transform: translateY(-4px) scale(1.02);
}

.trusted-seller-card {
  position: relative;
  width: 100%;
  height: 260px;
  border-radius: 1rem;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.25s ease;
}
.trusted-seller-card:hover {
  transform: scale(1.02);
}

.trusted-seller-bg {
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  filter: blur(3px);
  transform: scale(1.1);
}

.trusted-seller-center-text {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 2rem;
  font-weight: 800;
  color: white;
  text-shadow: 0 0 12px rgba(0,0,0,0.7);
}

/* Info panel that pops out below card on hover */
.trusted-seller-info-panel {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translate(-50%, 12px);
  width: 90%;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.35s ease, transform 0.35s ease;
}

.trusted-seller-info-inner {
  background: #ffffff;
  border-radius: 0 0 1rem 1rem;
  padding: 0.75rem 1rem;
  box-shadow: 0 18px 35px rgba(15,23,42,0.25);
  border-top: 1px solid rgba(148,163,184,0.65);
  font-size: 0.8rem;
  color: #111827;
}

.trusted-seller-info-title {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #6b7280;
  margin-bottom: 0.35rem;
  font-weight: 600;
}

.trusted-seller-info-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 0.15rem;
  gap: 0.5rem;
}

.trusted-seller-info-row-label {
  font-weight: 500;
  color: #4b5563;
}

.trusted-seller-info-notes {
  margin-top: 0.25rem;
  font-size: 0.75rem;
  color: #4b5563;
}

.trusted-seller-glow:hover .trusted-seller-info-panel {
  opacity: 1;
  transform: translate(-50%, 0);
}


</style>
</head>
<body class="text-gray-800 font-sans min-h-screen p-4 sm:p-8">
  <!-- Sidebar -->
  <div
    id="sidebar"
    class="fixed top-0 left-0 h-full w-64 p-6 shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 bg-white border-r border-subtle"
  >
    <div class="flex justify-between items-center mb-8">
      <h3 class="text-xl font-bold text-accent">Navigation</h3>
      <button
        onclick="toggleSidebar()"
        class="p-1 rounded-full text-gray-600 hover:bg-gray-100"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <nav class="flex flex-col space-y-3">
      <button
        onclick="navigate('data')"
        class="text-left py-2 px-3 rounded-lg font-medium text-primary-dark hover:bg-gray-100 transition flex items-center"
      >
        <svg
          class="w-5 h-5 mr-3 text-accent"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10h2m-2 0h2m2 0V7m2 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"
          ></path>
        </svg>
        Go to Spreadsheet
      </button>
      <button
        onclick="navigate('link-converter')"
        class="text-left py-2 px-3 rounded-lg font-medium text-primary-dark hover:bg-gray-100 transition flex items-center"
      >
        <svg
          class="w-5 h-5 mr-3 text-accent"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 11.5V14m0-2.5v-2.5m0 5h2m0-5h2m0 0H9m7 0a4 4 0 00-4 4v2m0 0v2m0-4h2m-2 0h2m0 0h2m0 0h2"
          ></path>
        </svg>
        Link Converter
      </button>
      <button
        onclick="navigate('trusted-sellers')"
        class="text-left py-2 px-3 rounded-lg font-medium text-primary-dark hover:bg-gray-100 transition flex items-center"
      >
        <svg
          class="w-5 h-5 mr-3 text-accent"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m5.618-4.104A9 9 0 0012 1m-1.765 1.765A9 9 0 003 12m18 0a9 9 0 01-9 9m-1.765-1.765A9 9 0 0121 12"
          ></path>
        </svg>
        Trusted Sellers
      </button>
      <button
        class="text-left py-2 px-3 rounded-lg font-medium text-primary-dark hover:bg-gray-100 transition flex items-center"
      >
        <svg
          class="w-5 h-5 mr-3 text-accent"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M14 10h4.764a2 2 0 011.857 2.193l-2.675 10.384A2 2 0 0118.427 22H5.573a2 2 0 01-1.936-2.533L5.836 12H10m-2 0V7A2 2 0 0110 5h4a2 2 0 012 2v5m-8 0h8"
          ></path>
        </svg>
        Socials
      </button>
    </nav>
  </div>

  <!-- Sidebar Backdrop -->
  <div
    id="sidebarBackdrop"
    onclick="toggleSidebar()"
    class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300 opacity-0"
  ></div>

  <!-- Main Container -->
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header
      class="header-gradient flex justify-between items-center mb-6 pb-4 rounded-b-xl shadow-md px-4 sm:px-8 pt-4"
    >
      <div class="flex items-center space-x-3">
        <svg
          onclick="toggleSidebar()"
          class="w-8 h-8 text-accent cursor-pointer"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h7"
          ></path>
        </svg>
        <img
          src="https://raw.githubusercontent.com/MinerBlox/website/refs/heads/main/images/mainlogo.png"
          alt="Reps Central Logo"
          class="h-10 cursor-pointer"
          onclick="navigate('home')"
        />
      </div>
      <div class="w-5 h-5"></div>
    </header>

    <!-- ITEM DETAILS VIEW -->
    <div id="details-view" class="hidden py-10">
      <button onclick="window.location='products.html'" 
              class="mb-6 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
        ← Back to all items
      </button>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
        <div class="flex justify-center">
          <img id="details-image" class="rounded-xl shadow mx-auto w-full max-w-xs md:max-w-md object-contain" />
        </div>
        <div>
          <h2 id="details-title" class="text-3xl font-bold mb-4"></h2>
          <p id="details-category" class="text-gray-500 mb-2"></p>
          <p id="details-price" class="text-2xl font-bold text-green-600 mb-4"></p>
<a id="buy-orientdig" href="#" target="_blank" class="mt-3 inline-block px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:opacity-90">BUY ON ORIENTDIG</a>
<a id="buy-orientdig" href="#" target="_blank" class="mt-3 inline-block px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:opacity-90">BUY ON ORIENTDIG</a>
          <span id="details-status" class="status-pill"></span>
        </div>
      </div>

      <div id="qc-status" class="text-gray-500 mt-6">Fetching QCs...</div>
<div id="qc-galleries" class="mt-4 grid gap-6"></div>
    </div>

    <!-- HOME VIEW -->
    <div id="data-view" class="py-10">
      <h2 class="text-3xl font-bold text-primary-dark mb-6">
        Product Spreadsheet
      </h2>

      <!-- Search & Filters -->
      <div
        class="mb-10 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4"
      >
        <div class="relative flex-grow">
          <input
            id="searchInput"
            type="text"
            placeholder="Search by item name or category..."
            class="w-full h-12 pl-10 pr-3 border border-subtle rounded-xl
                   focus:ring-2 focus:ring-accent focus:border-accent
                   transition duration-300 shadow-sm
                   bg-white text-primary-dark"
          />
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 transform w-5 h-5 text-gray-400 pointer-events-none"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            ></path>
          </svg>
        </div>

        <div class="relative w-full sm:w-48 z-10" id="customFilterDropdown">
          <button
            id="filterDisplay"
            onclick="toggleCustomDropdown()"
            class="w-full h-12 px-3 pr-10 border border-subtle rounded-xl shadow-sm cursor-pointer 
                   flex justify-between items-center font-medium text-primary-dark
                   bg-white hover:shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-accent"
            data-value="all"
          >
            <span id="filterLabel">Filter: All Categories</span>
            <svg
              id="dropdownArrow"
              class="w-4 h-4 text-gray-500 transition-transform duration-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>

          <div
            id="filterOptions"
            class="absolute top-full mt-2 w-full bg-white rounded-xl shadow-xl 
                   border border-subtle overflow-hidden 
                   max-h-0 transition-all duration-300 ease-in-out"
            style="z-index: 20"
          >
            <ul class="py-1">
              <li
                class="cursor-pointer p-3 hover:bg-subtle text-primary-dark"
                onclick="selectOption('all', 'Filter: All Categories')"
              >
                Filter: All Categories
              </li>
              <li
                class="cursor-pointer p-3 hover:bg-subtle text-primary-dark"
                onclick="selectOption('shoes', 'Shoes')"
              >
                Shoes
              </li>
              <li
                class="cursor-pointer p-3 hover:bg-subtle text-primary-dark"
                onclick="selectOption('clothing', 'Clothing')"
              >
                Clothing
              </li>
              <li
                class="cursor-pointer p-3 hover:bg-subtle text-primary-dark"
                onclick="selectOption('accessories', 'Accessories')"
              >
                Accessories
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Data Grid -->
      <main>
        <div
          id="itemGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
          <!-- Firestore items rendered here -->
        </div>
      </main>

      <!-- Footer -->
      <footer
        class="mt-12 pt-6 text-center text-sm text-gray-500 border-t border-subtle"
      >
        <span id="dataFooterText">Loading items...</span>
      </footer>
    </div>

    <!-- LINK CONVERTER VIEW -->
    
  </div>

  <script>

    // Sidebar toggling
    const sidebar = document.getElementById("sidebar");
    const sidebarBackdrop = document.getElementById("sidebarBackdrop");
    const body = document.body;
    let isSidebarOpen = false;

    function toggleSidebar() {
      isSidebarOpen = !isSidebarOpen;
      if (isSidebarOpen) {
        sidebar.classList.remove("-translate-x-full");
        sidebarBackdrop.classList.remove("hidden");
        setTimeout(() => sidebarBackdrop.classList.remove("opacity-0"), 10);
        body.classList.add("overflow-hidden");
      } else {
        sidebarBackdrop.classList.add("opacity-0");
        sidebar.classList.add("-translate-x-full");
        setTimeout(() => {
          sidebarBackdrop.classList.add("hidden");
          body.classList.remove("overflow-hidden");
        }, 300);
      }
    }

    // Navigate between the 4 standalone pages
    function navigate(page) {
      if (page === "home") {
        window.location.href = "index.html";
      } else if (page === "data") {
        window.location.href = "products.html";
      } else if (page === "link-converter") {
        window.location.href = "link-converter.html";
      } else if (page === "trusted-sellers") {
        window.location.href = "trusted-sellers.html";
      }
    }

    window.allItems = [];
    let currentFilterCategory = "all";

    function mapStatusToClass(status) {
      const s = (status || "").toLowerCase();
      if (s === "dead" || s === "link dead") return "status-dead";
      if (s === "low" || s === "low-stock" || s === "low stock")
        return "status-low-stock";
      if (s === "checking") return "status-checking";
      return "status-available";
    }

    function mapStatusLabel(status) {
      if (!status) return "Available";
      return status.charAt(0).toUpperCase() + status.slice(1);
    }

    function formatPrice(price) {
      if (price === undefined || price === null || price === "") return "";
      const p = String(price).trim();
      if (!p) return "";
      if (p.includes("¥")) return p;
      const numeric = p.replace(/[^\d.]/g, "");
      if (!numeric) return "";
      return "¥" + numeric;
    }

    let usdRatePromise = null;

    function getUsdRate() {
      if (!usdRatePromise) {
        usdRatePromise = fetch("https://api.exchangerate.host/latest?base=CNY&symbols=USD")
          .then((res) => res.json())
          .then((data) => (data && data.rates && data.rates.USD) ? data.rates.USD : 0.14)
          .catch(() => 0.14);
      }
      return usdRatePromise;
    }

    function extractNumericYuan(priceStr) {
      if (!priceStr) return 0;
      const match = String(priceStr).match(/[\d.]+/);
      return match ? parseFloat(match[0]) : 0;
    }

    function attachUsdApprox(cardEl, yuanDisplay) {
      const usdSpan = cardEl.querySelector(".price-usd");
      if (!usdSpan) return;
      const amount = extractNumericYuan(yuanDisplay);
      if (!amount) {
        usdSpan.textContent = "";
        return;
      }
      getUsdRate().then((rate) => {
        const usd = (amount * rate).toFixed(2);
        usdSpan.textContent = "≈ $" + usd;
      });
    }

    function renderItemsGrid(items, totalCount) {
      const container = document.getElementById("itemGrid");
      const footer = document.getElementById("dataFooterText");
      if (!container) return;

      container.innerHTML = "";

      if (!items || items.length === 0) {
        container.innerHTML =
          '<div class="col-span-1 md:col-span-2 lg:col-span-3 text-center text-gray-400 py-10">No items found. Try adjusting your search or filters.</div>';
      } else {
        items.forEach((item) => {
          const title = item.title || "Untitled item";
          const category = item.category || "Uncategorised";
          const price = formatPrice(item.price);
          const availability = item.status || item.availability || "available";
          const pillClass = mapStatusToClass(availability);
          const pillLabel = mapStatusLabel(availability);
          const img = item.imageUrl || item.image || "";
          const imageUrl =
            img ||
            "https://via.placeholder.com/400x192?text=Item+Image";
          const slug = item.slug || item.id || "";
          const safeButton =
  slug
    ? `<button class="text-sm text-accent font-semibold flex items-center hover:underline"
               onclick="window.location.href='products.html?id=${slug}'">
         View Details
         <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                 d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
         </svg>
       </button>`
    : `<button class="text-sm text-gray-400 font-medium cursor-not-allowed flex items-center" disabled>
         View Details
         <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                 d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
         </svg>
       </button>`;


          const cardHTML = `
            <div class="card bg-white p-4 rounded-2xl shadow-lg border border-gray-100 flex flex-col cursor-pointer" onclick="window.location.href='products.html?id=${item.slug || item.id}'">
              <div class="w-full h-48 mb-4 bg-accent rounded-xl flex items-center justify-center overflow-hidden">
                <img src="${imageUrl}" alt="${title}" class="object-contain w-full h-full bg-white p-2"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/400x192?text=No+Image';" />
              </div>
              <div class="px-1 pb-2 flex-1 flex flex-col">
                <h3 class="text-xl font-semibold mb-1 truncate text-primary-dark">${title}</h3>
                <p class="text-sm text-gray-500 mb-3">${category}</p>
                <div class="flex justify-between items-center mb-4">
                  <span class="text-2xl font-bold text-green-600">
                    <span class="price-yuan">${price}</span>
                    <span class="text-sm text-gray-500 ml-1 align-middle price-usd"></span>
                  </span>
                  <span class="status-pill ${pillClass}">${pillLabel}</span>
                </div>
              </div>
              <div class="border-t border-subtle pt-4 flex justify-between items-center px-1">
                ${safeButton}
                <span class="text-xs text-gray-400">${mapStatusLabel(
                  availability
                )}</span>
              </div>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", cardHTML);
          const cardEl = container.lastElementChild;
          attachUsdApprox(cardEl, price);
        });
      }

      if (footer) {
        footer.textContent =
          "Displaying " +
          items.length +
          " of " +
          (totalCount || items.length) +
          " total items.";
      }
    }

    // DROPDOWN
    let isDropdownOpen = false;
    function toggleCustomDropdown() {
      const optionsContainer = document.getElementById("filterOptions");
      const arrow = document.getElementById("dropdownArrow");

      if (!optionsContainer || !arrow) return;

      if (isDropdownOpen) {
        optionsContainer.classList.remove("max-h-60");
        optionsContainer.classList.add("max-h-0");
        arrow.classList.remove("rotate-180");
      } else {
        optionsContainer.classList.remove("max-h-0");
        optionsContainer.classList.add("max-h-60");
        arrow.classList.add("rotate-180");
      }
      isDropdownOpen = !isDropdownOpen;
    }

    function selectOption(value, label) {
      const displayLabel = document.getElementById("filterLabel");
      const displayButton = document.getElementById("filterDisplay");
      if (!displayLabel || !displayButton) return;

      displayLabel.textContent = label;
      displayButton.setAttribute("data-value", value);
      currentFilterCategory = value;

      applyFiltersAndRender();
      toggleCustomDropdown();
    }

    document.addEventListener("click", (event) => {
      const dropdown = document.getElementById("customFilterDropdown");
      if (isDropdownOpen && dropdown && !dropdown.contains(event.target)) {
        toggleCustomDropdown();
      }
    });

    // SEARCH / FILTER
    function applyFiltersAndRender() {
      const searchInput = document.getElementById("searchInput");
      const term = (searchInput?.value || "").toLowerCase().trim();

      let filtered = window.allItems.slice();

      if (term) {
        filtered = filtered.filter((item) => {
          const title = (item.title || "").toLowerCase();
          const category = (item.category || "").toLowerCase();
          return title.includes(term) || category.includes(term);
        });
      }

      if (currentFilterCategory !== "all") {
        filtered = filtered.filter((item) => {
          const cat = (item.category || "").toLowerCase();
          return cat.includes(currentFilterCategory);
        });
      }

      renderItemsGrid(filtered, window.allItems.length);
    }

    window.updateItemsFromFirestore = function (items) {
      window.allItems = items || [];
      applyFiltersAndRender();
    };

    window.addEventListener("load", () => {
      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
        searchInput.addEventListener("input", applyFiltersAndRender);
      }
    });

  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDTIzoJlvrr0mYxwx82cQ9JJn8rXrMEy7JA",
      authDomain: "reps-central.firebaseapp.com",
      projectId: "reps-central",
      storageBucket: "reps-central.firebasestorage.app",
      messagingSenderId: "812299387060",
      appId: "1:812299387060:web:1c93d1e7bf30b565536d7e1",
      measurementId: "G-8T7F9F1FZ9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const itemsCol = collection(db, "products");
    onSnapshot(itemsCol, (snapshot) => {
      const items = snapshot.docs.map((d) => ({
        id: d.id,
        ...d.data()
      }));
      if (window.updateItemsFromFirestore) {
        window.updateItemsFromFirestore(items);
      }
    });
  
// DETAILS VIEW LOGIC
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

async function loadDetailsIfNeeded(){
  const slug = getParam("id");
  if(!slug) return; // no details mode

  document.getElementById("data-view").classList.add("hidden");
  document.getElementById("details-view").classList.remove("hidden");

  const { getFirestore, collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");

  const q = query(collection(db, "products"), where("slug", "==", slug));
  const snap = await getDocs(q);

  if(snap.empty){
    document.getElementById("details-title").textContent = "Item not found.";
    return;
  }

  const item = snap.docs[0].data();
  window.loadedItem = item;

  document.getElementById("details-title").textContent = item.title;
  document.getElementById("details-category").textContent = item.category || "";
  document.getElementById("details-image").src = item.image || item.imageUrl || "";

  const price = formatPrice(item.price);
  document.getElementById("details-price").innerHTML = 
    price + ' <span class="text-sm text-gray-500" id="details-usd"></span>';

  // Attach USD conversion
  const amount = extractNumericYuan(price);
  getUsdRate().then(rate=>{
    const usd = (amount * rate).toFixed(2);
    document.getElementById("details-usd").textContent = "≈ $" + usd;
  });

  const status = item.status || item.availability || "Available";
  const pill = document.getElementById("details-status");
  pill.textContent = mapStatusLabel(status);
  pill.classList.add(mapStatusToClass(status));
}

window.addEventListener("load", loadDetailsIfNeeded);
</script>


<!-- QC MODAL -->
<div id="qc-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
  <button id="qc-close" class="absolute top-4 right-4 text-white text-4xl">&times;</button>
  <button id="qc-prev" class="absolute left-4 text-white text-4xl">&#10094;</button>
  <img id="qc-modal-img" class="max-w-full max-h-full mx-auto rounded-lg shadow-lg" />
  <button id="qc-next" class="absolute right-4 text-white text-4xl">&#10095;</button>
</div>

<script>
// QC system (debug off)
function convertOrientdig(url){ const u=new URL(url); return u.searchParams.get("id"); }

async function fetchQCs(id){
 try{ const r=await fetch(`/api/qc?goodsId=${id}`); if(!r.ok) return []; const d=await r.json(); return d.data||[]; }catch(e){ return []; }
}

function groupBySku(q){ const g={}; q.forEach(i=>{ (g[i.skuId]=g[i.skuId]||[]).push(i.photoUrl); }); return g; }

let cImgs=[],cIndex=0;
function openQC(imgs,i){ cImgs=imgs; cIndex=i; document.getElementById("qc-modal-img").src=imgs[i]; document.getElementById("qc-modal").classList.remove("hidden"); }
function closeQC(){ document.getElementById("qc-modal").classList.add("hidden"); }
function prevQC(){ cIndex=(cIndex-1+cImgs.length)%cImgs.length; document.getElementById("qc-modal-img").src=cImgs[cIndex]; }
function nextQC(){ cIndex=(cIndex+1)%cImgs.length; document.getElementById("qc-modal-img").src=cImgs[cIndex]; }

window.addEventListener("load",()=>{
 let c=document.getElementById("qc-close"),p=document.getElementById("qc-prev"),n=document.getElementById("qc-next");
 if(c) c.onclick=closeQC; if(p) p.onclick=prevQC; if(n) n.onclick=nextQC;
});

const oldLoad=loadDetailsIfNeeded;
loadDetailsIfNeeded=async function(){
 await oldLoad();
 const item=window.loadedItem; if(!item) return;
 const gid=convertOrientdig(item.url);
 document.getElementById("buy-orientdig").href=item.url;
 const list=await fetchQCs(gid);
 const st=document.getElementById("qc-status"), cont=document.getElementById("qc-galleries");
 if(!list.length){ st.textContent="No QCs Available."; return; }
 st.textContent="";
 const groups=groupBySku(list);
 for(const [sku,imgs] of Object.entries(groups)){
  const wrap=document.createElement("div");
  wrap.innerHTML=`<h3 class="text-lg font-semibold mb-2">QC Set – ${sku}</h3>`;
  const grid=document.createElement("div"); grid.className="grid grid-cols-3 gap-2";
  imgs.forEach((u,i)=>{ const im=document.createElement("img"); im.src=u; im.className="rounded shadow cursor-pointer"; im.onclick=()=>openQC(imgs,i); grid.appendChild(im); });
  wrap.appendChild(grid);
  cont.appendChild(wrap);
 }
};
</script>
</body>
</html>
